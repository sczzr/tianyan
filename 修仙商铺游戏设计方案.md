# 《天衍峰：修仙商铺》游戏设计方案

**版本**: 1.0
**日期**: 2026-01-27
**作者**: AI Assistant

---

## 一、游戏概述

### 1.1 游戏名称
**《天衍峰：修仙商铺》**（暂定）

### 1.2 核心概念
玩家扮演天衍峰集市中的一名商铺掌柜，通过经营修仙物品（丹药、符箓、阵法、傀儡等）影响NPC修士的命运轨迹，同时自身修炼成长，体验修仙世界的百态人生。

### 1.3 游戏特色
- **经营+修仙**：融合模拟经营与修仙养成
- **NPC命运系统**：500+程序化生成的NPC，每个都有独立故事线
- **LLM驱动交互**：自然语言与NPC自由交互，无预设选项限制
- **影响与观察**：玩家的每个决策都会影响NPC的人生轨迹

---

## 二、核心玩法循环

### 2.1 基础循环
```
收集材料 → 制作物品 → 出售给NPC → 赚取灵石 → 购买材料/修炼 → 收集材料
```

### 2.2 进阶循环
```
观察NPC需求 → 针对性制作 → 影响NPC命运 → 解锁新故事 → 获得稀有材料 →
制作高级物品 → 提升修为 → 观察NPC需求
```

### 2.3 核心乐趣点
1. **修仙体验**：研究功法、自创丹药、探索天篆奥秘
2. **NPC互动**：通过售卖物品影响NPC人生轨迹，观察百态人生
3. **经营模拟**：从小摊位发展到连锁商铺，体验经营乐趣

---

## 三、LLM集成方案

### 3.1 技术架构
```
┌─────────────────────────────────────────┐
│         Godot 游戏客户端                │
│  ┌─────────────────────────────────┐  │
│  │      LlamaSharp Manager         │  │
│  │  ┌──────────┬─────────────────┐  │  │
│  │  │ 模型加载 │ GPU/CPU 推理调度 │  │  │
│  │  └──────────┴─────────────────┘  │  │
│  └─────────────────────────────────┘  │
│  ┌─────────────────────────────────┐  │
│  │      NPC 对话系统               │  │
│  │  - 意图识别                     │  │
│  │  - 上下文管理                   │  │
│  │  - 对话生成                     │  │
│  └─────────────────────────────────┘  │
│  ┌─────────────────────────────────┐  │
│  │      RAG 知识检索               │  │
│  │  - Chroma 向量数据库            │  │
│  │  - NPC 背景知识                 │  │
│  │  - 游戏世界设定                 │  │
│  └─────────────────────────────────┘  │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│      LlamaSharp (llama.cpp C#绑定)    │
│  Model: Qwen3-4B-Q5_K_M.gguf          │
│  Backend: CUDA / Metal / CPU            │
└─────────────────────────────────────────┘
```

### 3.2 LLM与游戏交互流程

#### 3.2.1 玩家输入处理
1. **自然语言输入**：玩家通过文本输入与NPC交互
2. **意图识别**：LLM解析玩家意图（交易、对话、威胁、赠送等）
3. **行为参数化**：将自然语言转换为结构化数据
```json
{
  "action": "give_item",
  "item": {"name": "筑基丹", "value": 1000},
  "manner": {"friendly": true, "stealth": false},
  "target_npc": "萧云"
}
```

#### 3.2.2 NPC反应生成
1. **状态查询**：获取NPC当前状态（关系值、情绪、目标等）
2. **RAG知识检索**：从知识库检索相关背景信息
3. **LLM生成**：生成符合NPC性格和当前情境的自然反应
4. **安全验证**：确保反应不违反游戏规则

#### 3.2.3 游戏逻辑执行
1. **资源验证**：检查交易是否合法（NPC是否有足够灵石）
2. **状态更新**：更新NPC关系值、情绪、物品栏
3. **故事推进**：根据玩家行为推进NPC故事节点
4. **世界反馈**：NPC命运变化影响游戏世界（如萧云建立商盟导致材料价格下降）

### 3.3 性能优化
- **模型量化**：使用Q5_K_M量化，平衡质量和速度
- **GPU加速**：加载35层到GPU，剩余用CPU
- **缓存机制**：缓存常见交互结果，减少LLM调用
- **批量处理**：累积多个NPC请求批量处理
- **异步处理**：LLM调用异步执行，不阻塞游戏主线程

---

## 四、NPC系统设计

### 4.1 NPC数据结构
```json
{
  "id": "npc_001",
  "name": "萧云",
  "background": "家族弃子",
  "personality": "谨慎",
  "cultivation": {
    "realm": "练气期",
    "level": "后期",
    "spirit_root": "四灵根"
  },
  "relationship_with_player": 30,
  "emotions": {
    "trust": 30,
    "fear": 0,
    "gratitude": 0,
    "suspicion": 20
  },
  "current_goal": "获得筑基丹",
  "story_stage": 2,
  "inventory": [
    {"item_id": "spirit_stone_001", "quantity": 50}
  ],
  "story_nodes": [
    {
      "stage": 1,
      "description": "被家族抛弃，来到天衍峰",
      "state": "completed"
    },
    {
      "stage": 2,
      "description": "急需筑基丹突破",
      "state": "active",
      "requirements": ["筑基丹"],
      "branches": {
        "success": "成功筑基，感激玩家",
        "failure": "筑基失败，铤而走险"
      }
    }
  ]
}
```

### 4.2 故事节点系统
每个NPC有3-8个动态故事节点，玩家行为影响节点走向：

**示例：萧云的故事线**
- **节点1（已完成）**：家族弃子，来到天衍峰集市谋生
- **节点2（进行中）**：练气大圆满，急需筑基丹
  - **玩家给筑基丹**：关系+50，解锁节点3（报恩）
  - **玩家拒绝**：萧云铤而走险，解锁节点2.1（禁地探险）
  - **玩家高价出售**：关系-20，萧云记恨
- **节点3（未解锁）**：萧云成功筑基，成为玩家忠实盟友
- **节点4（未解锁）**：萧云建立商盟，改变天衍峰经济格局

### 4.3 关系网络
- **动态关系**：NPC之间会互相交流，传播玩家声誉
- **连锁反应**：帮助一个NPC可能影响其朋友/敌人
- **可视化**：星图展示500+NPC的关系网络

---

## 五、经济系统设计

### 5.1 货币体系
| 货币类型 | 价值 | 用途 |
|---------|------|------|
| 下品灵石 | 1 | 练气期交易 |
| 中品灵石 | 100 | 筑基/金丹期交易 |
| 上品灵石 | 10,000 | 元婴期以上交易 |
| 极品灵石 | 1,000,000 | 战略资源 |

### 5.2 物品分类
1. **丹药**：筑基丹、破境丹、疗伤丹等
2. **符箓**：攻击符、防御符、辅助符
3. **阵法**：聚灵阵、防御阵、传送阵
4. **傀儡**：战斗傀儡、采矿傀儡、服务傀儡
5. **材料**：灵草、矿石、妖兽材料

### 5.3 价格动态
- **供需关系**：NPC大量购买某物品会导致价格上涨
- **世界事件**：妖兽攻城导致材料短缺，价格飙升
- **玩家影响**：大量出售某物品会压低价格
- **NPC行为**：NPC商人会根据市场波动调整收购价

---

## 六、修炼系统设计

### 6.1 修为境界
- **练气期**：100-150年寿元，可制作低级物品
- **筑基期**：200-300年寿元，可制作中级物品
- **金丹期**：500-800年寿元，可制作高级物品
- **元婴期**：1500-2500年寿元，可制作顶级物品
- **化神期**：3000-5000年寿元，可制作传说物品

### 6.2 修炼机制
- **时间分配**：玩家需平衡经营时间和修炼时间
- **瓶颈突破**：需要特定丹药或机缘
- **功法研究**：可自创功法，提升制作效率
- **天篆研究**：研究世界法则，解锁新配方

---

## 七、技术实现方案

### 7.1 技术栈
- **游戏引擎**：Godot 4.5.1-stable (Mono/C# 版本)
- **LLM集成**：LlamaSharp (llama.cpp C#绑定)
- **模型**：Qwen3-4B-Q5_K_M.gguf（本地部署）
- **数据库**：SQLite（NPC数据）
- **向量数据库**：Chroma（RAG知识检索）

### 7.2 LlamaSharp 集成架构

#### 7.2.1 LlamaSharp 简介
LlamaSharp 是 llama.cpp 的 C# 绑定，允许在 Unity 中直接运行本地 LLM 推理，无需独立的后端服务。

**核心优势：**
- **一体化架构**：无需 FastAPI 后端，减少网络延迟
- **Unity 原生**：C# API 直接集成到游戏脚本
- **跨平台**：支持 Windows、Linux、macOS、Android
- **硬件加速**：CUDA/Metal/DirectML 后端支持

#### 7.2.2 Unity 集成架构
```
┌─────────────────────────────────────────┐
│         Godot 游戏客户端                │
│  ┌─────────────────────────────────┐  │
│  │      LlamaSharp Manager         │  │
│  │  ┌──────────┬─────────────────┐  │  │
│  │  │ 模型加载 │ GPU/CPU 推理调度 │  │  │
│  │  └──────────┴─────────────────┘  │  │
│  └─────────────────────────────────┘  │
│  ┌─────────────────────────────────┐  │
│  │      NPC 对话系统               │  │
│  │  - 意图识别                     │  │
│  │  - 上下文管理                   │  │
│  │  - 对话生成                     │  │
│  └─────────────────────────────────┘  │
│  ┌─────────────────────────────────┐  │
│  │      RAG 知识检索             │  │
│  │  - Chroma 向量数据库          │  │
│  │  - NPC 背景知识               │  │
│  │  - 游戏世界设定               │  │
│  └─────────────────────────────────┘  │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│      LlamaSharp (llama.cpp C#绑定)    │
│  Model: Qwen3-4B-Q5_K_M.gguf          │
│  Backend: CUDA / Metal / CPU            │
└─────────────────────────────────────────┘
```

#### 7.2.3 核心代码实现
```csharp
// LlamaSharpManager - Godot 单例管理器
using LlamaSharp;
using LlamaSharp.Grammar;
using System.Threading.Tasks;
using Godot;

public partial class LlamaSharpManager : Node
{
    public static LlamaSharpManager Instance { get; private set; }

    private LLamaWeights model;
    private LLamaContext context;
    private InteractiveExecutor executor;

    public override void _Ready()
    {
        if (Instance == null)
        {
            Instance = this;
            ProcessMode = ProcessModeEnum.Always; // 等同于 Unity 的 DontDestroyOnLoad
            InitializeModel();
        }
    }

    void InitializeModel()
    {
        var modelPath = System.IO.Path.Combine(
            ProjectSettings.GlobalizePath("res://"),
            "Models",
            "Qwen3-4B-Q5_K_M.gguf"
        );

        var parameters = new ModelParams(modelPath)
        {
            ContextSize = 4096,
            GpuLayerCount = 35,  // GPU 加速层数
            Seed = (uint)GD.RandRange(1, 100000)
        };

        model = LLamaWeights.LoadFromFile(parameters);
        context = model.CreateContext(parameters);
        executor = new InteractiveExecutor(context);
    }

    public async Task<string> GenerateNPCResponse(NPCData npc, string playerInput, string conversationHistory)
    {
        var prompt = BuildPrompt(npc, playerInput, conversationHistory);

        var inferenceParams = new InferenceParams()
        {
            Temperature = 0.7f,
            MaxTokens = 150,
            AntiPrompts = new List<string> { "玩家:", "NPC:", "</s>" }
        };

        string result = "";
        await Task.Run(() =>
        {
            foreach (var token in executor.Infer(prompt, inferenceParams))
            {
                result += token;
            }
        });

        return result.Trim();
    }

    private string BuildPrompt(NPCData npc, string playerInput, string history)
    {
        return $@"你是修仙世界《天衍峰》中的一位NPC。

【角色信息】
姓名: {npc.name}
背景: {npc.background}
性格: {npc.personality}
修为: {npc.cultivation.realm} {npc.cultivation.level}
当前目标: {npc.currentGoal}
与玩家关系: {npc.relationship} (0-100)

【对话历史】
{history}

【当前情境】
玩家对你说: """{playerInput}"""

【角色扮演要求】
1. 用第一人称回复，符合你的性格和背景
2. 回复要自然、有情感，避免机械感
3. 考虑你与玩家的关系值 ({npc.relationship}/100)
4. 回复长度控制在50-150字
5. 不要出现OOC（脱离角色）的内容

你的回复:";
    }

    public override void _ExitTree()
    {
        context?.Dispose();
        model?.Dispose();
    }
}
```

#### 7.2.4 性能优化
- **模型量化**：使用Q5_K_M量化，平衡质量和速度
- **GPU加速**：通过GpuLayerCount配置GPU层数
- **异步推理**：使用Task.Run异步执行，避免阻塞Godot主线程
- **响应缓存**：缓存常见NPC反应，减少LLM调用
- **对象池**：重用LlamaContext和Executor实例减少垃圾回收压力
- **上下文管理**：智能截断对话历史，控制上下文长度

---

## 八、美术与音效风格

### 8.1 视觉风格
- **像素风**：16-bit像素艺术，复古修仙氛围
- **色彩**：低饱和度，水墨画风格
- **UI设计**：简洁古朴，符合修仙世界审美
- **动画**：帧动画表现法术、炼丹等特效

### 8.2 音效设计
- **背景音乐**：古筝、笛子等民族乐器，营造修仙氛围
- **音效**：炼丹炉火焰声、符箓燃烧声、灵石碰撞声
- **NPC语音**：LLM生成文本，TTS转换为语音（可选）

---

## 九、开发路线图

### 阶段1：核心系统（1-2个月）
- [ ] 基础商铺经营系统
- [ ] 50个核心NPC（手工设计）
- [ ] 基础物品制作系统
- [ ] LlamaSharp Unity 集成
- [ ] 简单修炼系统

### 阶段2：内容扩展（2-3个月）
- [ ] 程序化NPC生成系统
- [ ] 500个NPC完整生态
- [ ] 复杂故事线系统
- [ ] 经济系统平衡
- [ ] 天篆研究系统

### 阶段3：优化与打磨（1-2个月）
- [ ] 性能优化（GPU加速、缓存）
- [ ] UI/UX优化
- [ ] 音效与音乐
- [ ] 平衡性调整
- [ ] Bug修复

### 阶段4：发布准备（1个月）
- [ ] Steam页面制作
- [ ] 预告片制作
- [ ] 社区运营
- [ ] 早期测试

---

## 十、创新点与竞争优势

### 10.1 创新点
1. **LLM驱动的NPC生态**：每个NPC都有独立人生，玩家的选择真实影响世界
2. **自由交互**：无预设对话选项，真正自然语言交互
3. **经营与修仙融合**：不仅是经营，更是体验修仙百态
4. **程序化叙事**：500+NPC生成无限故事组合

### 10.2 竞争优势
- **差异化**：市场上无同类LLM驱动修仙经营游戏
- **沉浸感**：NPC反应真实自然，打破传统游戏对话树限制
- **重玩价值**：每次游戏NPC组合和故事都不同
- **技术壁垒**：本地LLM部署+优化方案

---

## 十一、风险与应对

### 11.1 技术风险
- **LLM响应延迟**：通过缓存、批处理、混合架构优化
- **GPU显存不足**：支持4GB显存，分层加载模型
- **模型幻觉**：通过RAG知识库+输出验证确保安全

### 11.2 设计风险
- **NPC行为失控**：三层安全防护（输入过滤、提示词加固、输出验证）
- **经济系统崩坏**：设置价格浮动上限，NPC有预算限制
- **玩家恶意利用**：禁止LLM执行管理命令，所有资源变更需游戏逻辑验证

### 11.3 市场风险
- **玩家接受度**：提供传统对话模式作为备选
- **硬件要求高**：优化低配模式，支持CPU-only运行
- **内容审核**：本地模型避免网络审查问题

---

## 十二、预期成果

### 12.1 游戏规模
- **NPC数量**：500个程序化生成NPC
- **物品数量**：200+可制作物品
- **故事节点**：2000+故事节点组合
- **游戏时长**：主线20小时，全探索100+小时

### 12.2 技术性能
- **响应时间**：NPC对话1-2秒生成
- **并发支持**：同时处理10个NPC交互
- **显存占用**：4GB显存可流畅运行
- **存储空间**：模型+游戏<10GB

---

## 十三、结语

本方案通过创新的LLM集成方式，打造前所未有的修仙世界体验。玩家不仅是旁观者，更是这个世界的参与者和塑造者。每个NPC都有自己的人生，每个选择都有真实的后果，让修仙世界真正"活"起来。

技术方案务实可行，已在本地验证LLM服务稳定性。下一步将进入原型开发阶段，验证核心玩法循环。

---

**附录**

### A. 技术文档索引
- `LlamaSharpManager.cs` - LlamaSharp Unity 管理器
- `NPCDialogSystem.cs` - NPC 对话系统
- `IntentRecognizer.cs` - 意图识别系统
- `RAGKnowledgeBase.cs` - RAG 知识检索系统
- `NPCData.cs` - NPC 数据定义

### B. 参考资源
- LlamaSharp: https://github.com/SciSharp/LlamaSharp
- llama.cpp文档: https://github.com/ggerganov/llama.cpp
- Godot 官方文档: https://docs.godotengine.org
- RAG原理: https://www.pinecone.io/learn/retrieval-augmented-generation

### C. 模型下载
- Qwen3-4B-Q5_K_M.gguf: https://huggingface.co/Qwen/Qwen3-4B-Chat-GGUF

---

**文档版本历史**
- v1.0 (2026-01-27): 初始版本

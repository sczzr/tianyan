# 生物与原材料系统技术实现 (v1.1)

本篇文档阐述了游戏中生物（妖兽、灵植）、原材料以及所有核心游戏数据的管理体系。该系统是整个游戏数据驱动设计的基石。

---

## 1. 核心数据模型 (Data-Driven)

所有核心游戏数据（物品、生物、天篆、配方等）都存储在外部JSON文件中，便于管理和Mod扩展。

### 1.1 物品 (`ItemData.cs` & `Item.cs`)

我们区分**静态数据 (`ItemData`)** 和 **运行时实例 (`Item`)**。`ItemData`是从JSON加载的模板，而`Item`是玩家背包中真实存在的、可能带有独立状态（如耐久度）的物品。

```csharp
// The base template for all items, loaded from JSON.
public class ItemData
{
    public string ID { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public ItemRarity Rarity { get; set; }
    public float BasePrice { get; set; }
    public bool IsStackable { get; set; } = true;
    public string IconPath { get; set; }
}

// A runtime instance of an item in an inventory.
public class Item
{
    public string ItemID { get; private set; } // References ItemData.ID
    public int StackSize { get; set; }

    // Instance-specific properties, e.g., for equipment
    public float Durability { get; set; }
    public List<string> AffixIDs { get; set; } // Instance-specific affixes

    public Item(string itemID, int stackSize = 1)
    {
        this.ItemID = itemID;
        this.StackSize = stackSize;
    }
    
    // Helper to get base data
    public ItemData GetData() => DataManager.Instance.AllItems[ItemID];
}

public enum ItemRarity { Common, Uncommon, Rare, Epic, Legendary }
```

### 1.2 原材料 (`RawMaterialData.cs`)
```csharp
// Inherits from ItemData, adds material-specific fields.
public class RawMaterialData : ItemData
{
    public MaterialType Type { get; set; }
    public List<string> Regions { get; set; }
}
public enum MaterialType { Herb, Ore, MonsterPart, Wood, Gem }
```

### 1.3 生物 (`CreatureData.cs`)
```csharp
// Data for a creature/monster (妖兽)
public class CreatureData
{
    public string ID { get; set; }
    public string Name { get; set; }
    public StatBlock BaseStats { get; set; }
    public string LootTableID { get; set; }
    public string Behavior { get; set; }
    
    // NEW: List of abilities the creature can use in combat.
    public List<string> AbilityIDs { get; set; }
}
```

### 1.4 灵植 (`SpiritPlantData.cs`)
```csharp
// Data for a spirit plant (灵植)
public class SpiritPlantData
{
    public string ID { get; set; }
    public string Name { get; set; }
    public int GrowthTime { get; set; } // Game hours
    public int MaxHarvests { get; set; }
    public string HarvestTableID { get; set; }
}
```

### 1.5 掉落/采集表 (`LootTableData.cs`)
```csharp
// Renamed to LootTableData for consistency
public class LootTableData
{
    public string ID { get; set; }
    public List<LootEntry> Entries { get; set; }
}

public class LootEntry { /* ... as before ... */ }
```

---

## 2. 核心管理系统

### 2.1 数据管理器 (`DataManager.cs`) - The Central Data Hub

`DataManager`是 **游戏数据的唯一来源**。它在启动时加载所有核心`.json`文件，并为其他所有管理器提供访问这些数据的接口。它必须是第一个被加载的Autoload单例。

```csharp
using Godot;
using System.Collections.Generic;

public partial class DataManager : Node
{
    public static DataManager Instance { get; private set; }
    
    // Dictionaries for all static game data
    public Dictionary<string, ItemData> AllItems { get; private set; }
    public Dictionary<string, CreatureData> AllCreatures { get; private set; }
    public Dictionary<string, SpiritPlantData> AllPlants { get; private set; }
    public Dictionary<string, LootTableData> AllLootTables { get; private set; }
    public Dictionary<string, TianZhuanData> AllTianZhuans { get; private set; }
    public Dictionary<string, RecipeData> AllRecipes { get; private set; }
    public Dictionary<string, AbilityData> AllAbilities { get; private set; }
    public Dictionary<string, StoryNode> AllStoryNodes { get; private set; }

    public override void _EnterTree() { Instance = this; }
    
    public override void _Ready()
    {
        // Centralized loading logic for all data types
        LoadAllData();
    }
    
    private void LoadAllData() 
    { 
        // LoadItems();
        // LoadCreatures();
        // LoadTianZhuans();
        // etc.
    }
}
```

### 2.2 掉落/采集管理器 (`LootManager.cs`)
```csharp
// ... (no changes, but now it gets LootTableData from DataManager)
public List<Item> ProcessLootTable(string tableID)
{
    if (!DataManager.Instance.AllLootTables.TryGetValue(tableID, out var table))
    {
        // ...
    }
    // ...
}
```

### 2.3 生成管理器 (`SpawnManager.cs`)
// ... (no changes to concept)

---

## 3. 与其他系统的集成

- **所有系统**: 所有需要访问静态游戏数据（如物品属性、天篆效果、配方成分）的管理器，都**必须**通过`DataManager.Instance`来获取，而不是自己加载文件。
- **制作系统**: `CraftingManager`从`DataManager`获取`RecipeData`。
- **角色系统**: 妖兽 (`CreatureData`) 在战斗层面被视为一个战斗实体。其`BaseStats`和`AbilityIDs`被`Combatant`组件用来初始化其实际战斗能力。
- **世界框架**: 场景的生态区配置决定了`SpawnManager`可以从`DataManager`调取哪些`CreatureData`和`SpiritPlantData`进行生成。

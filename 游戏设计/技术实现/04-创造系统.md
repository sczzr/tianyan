# 创造系统技术实现

本篇文档整合了游戏中所有与“创造”相关的系统，包括为物品和角色添加多样性的“词条系统”，以及允许玩家开创新配方的“衍化创法”系统。

---

## 1. 词条系统 (Affix System)

该系统旨在为游戏中的实体提供丰富的随机属性和特殊行为。

### 1.1 核心概念
- “词条”是一个可附加的数据包，用于描述一种修正或特性。
- **应用范围**: 可应用于物品（武器、丹药）、角色（NPC、玩家）、功法，乃至洞天福地的地块。
- **生成方式**: 主要来源于制作产出（品质越高越好）、NPC天生自带、以及后天奇遇或事件获得。

### 1.2 技术实现 (`AffixManager.cs`)
- **数据驱动**: 所有词条效果均在外部`Affixes.json`中定义，便于Mod拓展。
- **效果类型**:
  - **`STAT_MOD` (属性修改)**: 最常见的类型，直接修改目标的数值。通过`modification`字段（`ADD`或`MULTIPLY`）来定义是加算还是乘算。
  - **`BEHAVIOR_MOD` (行为注入)**: 附加特殊行为脚本，通过全局事件总线触发。例如，一个词条可以监听`OnAttackHit`事件，并执行一个`vampiric_behavior.gd`脚本来实现吸血效果。
- **`IAffixable`接口**:
  - 定义了一个通用接口，任何需要附加词条的类（如`CharacterData`, `ItemInstance`）都应实现它。
  - 接口包含`List<string> AffixIDs`，以及`BaseStats`和`FinalStats`等属性。
- **`CalculateStats`核心函数**: `AffixManager`提供的核心服务，用于计算一个`IAffixable`实体的最终属性。它会遍历实体身上所有的永久词条和临时状态，应用所有`STAT_MOD`效果，得出最终结果。

### 1.3 UI呈现
- 在所有涉及物品或角色的**信息提示框 (Tooltip)**中，增加“词条”区域，并根据词条的`tier`（品阶），用不同颜色（橙/传说，紫/稀有，绿/正面，红/负面）显示，使其效果一目了然。

---

## 2. 生成式创造系统 (“衍化创法”)

这是游戏的终极创造玩法，允许玩家通过实验发现新配方，其核心是**“玩家属性决定成败，LLM丰富成败细节”**。

### 2.1 核心机制：两步式创造

#### 第一步：成功率检定 (由角色属性决定)
- **时机**: 玩家在“衍化台”上组合好材料和天篆工序，点击“衍化”后，系统**首先**在本地进行此检定。
- **核心公式**: `SuccessChance = BaseChance + KnowledgeBonus + AttributeBonus + MaterialBonus + TimeBonus`
- **决定性因素**:
  - **`KnowledgeBonus` (知识加成)**: **权重最高的加成项**。角色在相关领域的“知识等级”是成功的基础，知识为零则无法成功。
  - **`AttributeBonus` (天赋加成)**: 包括角色的“生产天赋”、“灵根契合度”、“悟性”等。
  - **其他因素**: 投入的材料品质、数量和衍化时长。
- **结果**: 若此次“摇骰子”失败，则流程直接结束，触发失败后果（如炸炉），**LLM不会被调用**。这确保了玩家的积累和成长是创法成功的硬门槛。

#### 第二步：LLM内容生成 (由组合逻辑决定)
- **时机**: 仅在**成功率检定通过后**，系统才会调用LLM。
- **提示词工程 (Prompt Engineering)**:
  - 系统将玩家的组合（材料、天篆）以及**成功裕度**（如`"success_margin": "CRITICAL_SUCCESS"`）一同打包，发送给一个被预设了修真世界“物理法则”的LLM。
- **结果固化**:
  - LLM根据组合的逻辑性，返回一个描述产物的JSON。
  - 游戏解析JSON，生成一件**全新的、拥有名字、描述和效果的物品**。
  - 同时，系统为玩家自动创建一张**“自创蓝图”**，存入其知识库，以便日后稳定复现。

### 2.2 UI交互 (`CreationAltarUI.tscn`)
- 一个专用的“衍化台”界面，提供材料槽、天篆序列轴、时长选择和“衍化”按钮。
- 最终结果会通过一段玄妙的动画后揭示。

# 角色系统技术实现 (v1.1)

本篇文档整合了与角色（玩家和NPC）自身相关的所有设计，包括其成长、属性、状态、AI驱动力以及叙事框架，是构建一个有血有肉的“修仙者”的数据蓝图。

---

## 1. 角色数据模型 (`CharacterData.cs`)

这是角色所有数据的统一载体，实现了`IAffixable`接口，以便与词条系统交互。

```csharp
public class CharacterData : IAffixable
{
    // 核心身份
    public CoreIdentityData Identity { get; set; }
    // 社交与叙事
    public SocialData Social { get; set; }
    public StoryData Story { get; set; }
    // 成长天赋
    public CultivationAptitudeData CultivationAptitude { get; set; }
    public ProductionAptitudeData ProductionAptitude { get; set; }
    public KnowledgeData Knowledge { get; set; }
    // 战斗与健康
    public StatBlock BaseStats { get; set; }
    public StatBlock FinalStats { get; set; } // 动态计算
    public HealthSystemData HealthData { get; set; }
    public Dictionary<EquipmentSlot, string> Equipment { get; set; }
    // 动态状态
    public List<ActiveEffect> ActiveEffects { get; set; } // 临时词条
    public List<string> AffixIDs { get; set; } // 永久词条
    
    public void RecalculateStats() { /* ... */ }
}
```

---

## 2. 角色属性与状态

角色的属性划分为九个核心模块：

### 2.1 核心身份 (Core Identity)
- `string ID`, `string Name`, `int Age`, `long MaxLifespan`, `string Gender`, `string PersonalityID`, `string BackgroundID`.

### 2.2 社交与叙事属性 (Social & Narrative Attributes)
这是驱动NPC行为和故事发展的核心数据。
- **`Dictionary<string, int> Relationships`**: 关系。存储与其他角色ID的好感度。
- **`Dictionary<EmotionType, int> Emotions`**: 情绪。如`Trust`(信任), `Gratitude`(感激), `Suspicion`(猜疑), `Fear`(恐惧)。这些值会受玩家交互的直接影响。
- **`NeedData Needs`**: 需求。分为`Immediate`(燃眉之急), `ShortTerm`(短期目标), `LongTerm`(长期夙愿)。是NPC AI决策的重要输入。
- **`string CurrentGoal`**: 当前最高优先级的目标，由AI根据需求、情绪和故事节点动态设定。
- **`int StoryStage`**: 记录该NPC主线故事进行到的阶段。

### 2.3 修炼天赋 (Cultivation Aptitude)
- **核心天赋**: `SpiritRoot`(灵根), `Comprehension`(悟性), `Gengu`(根骨), `Fortune`(气运)。
- **神识相关**: `Spirit`(神识), `DivineSenseRange`(神念范围), `MentalResilience`(精神韧性)。

### 2.4 生产天赋 (Production Talent)
- `Dictionary<ProductionArt, ProductionTalent> Talents`，记录角色在“修真百艺”上的天赋与熟练度。

### 2.5 知识体系 (Knowledge System)
- `Dictionary<KnowledgeDomain, DomainKnowledge> Domains`，记录角色在特定领域的知识积累，是“衍化创法”的关键。

### 2.6 战斗属性 (Combat Attributes)
- `BaseStats` (基础属性) 和 `FinalStats` (最终属性)。

### 2.7 健康状态 (Health & Body)
- `BodyParts` (五脏、四肢) 和 `RealmBodyPart` (气海、金丹、元婴)。

### 2.8 装备与外观 (Equipment & Appearance)
- `Dictionary<EquipmentSlot, string> Equipment`，包含十多个可穿戴部位。

### 2.9 动态状态 (Dynamic States)
- `List<ActiveEffect>`，管理临时的Buff和Debuff。

---

## 3. 玩家成长系统
- **修炼系统 (`CultivationManager.cs`)**: 处理经验、升级与突破。
- **技能树/天篆系统 (`SkillManager.cs`)**: 处理“悟性”和天篆的解锁。

---

## 4. 叙事与故事节点系统

该系统负责驱动每个NPC的个人故事线，并响应玩家的行为。

### 4.1 节点数据结构 (`StoryNode.json`)
每个NPC的故事线由3-8个动态故事节点组成，这些节点的定义存储在外部JSON文件中，便于管理和Mod拓展。

```json
{
  "node_id": "xiaoyun_node_2",
  "title": "筑基之难",
  "description": "萧云修为已至练气圆满，却苦于没有筑基丹，无法迈出关键一步。",
  "stage": 2,
  "trigger_conditions": { // 节点的触发条件
    "npc_relationship": {"min": 20},
    "npc_cultivation_realm": "练气期",
    "npc_cultivation_level": "后期"
  },
  "player_interaction_options": [ // 玩家在此节点可以采取的关键互动
    {
      "option": "赠送筑基丹",
      "effects": { "relationship": 50, "npc_emotion_gratitude": 30, "next_node": "xiaoyun_node_3_success" }
    },
    {
      "option": "高价出售筑基丹",
      "effects": { "relationship": -20, "npc_emotion_resentment": 20, "next_node": "xiaoyun_node_2_alt_1" }
    },
    {
      "option": "拒绝帮助",
      "effects": { "relationship": -30, "next_node": "xiaoyun_node_2_alt_2" }
    }
  ],
  "npc_auto_branches": { // 如果玩家不干预，NPC可能自动选择的分支
    "default": "xiaoyun_node_2_alt_2", // 默认会走向“铤而走险”
    "conditions": [
      {
        "if_npc_personality": "Cautious", // 如果NPC性格谨慎
        "then_node": "xiaoyun_node_2_alt_3" // 他可能会选择“继续等待”
      }
    ]
  }
}
```

### 4.2 核心逻辑 (`StoryManager.cs` 与 `NPCManager.cs`)
- **`StoryManager`**:
  - **加载**: 游戏启动时，加载所有NPC的故事节点JSON文件。
  - **检定**: `CheckAndTriggerNode(NPCData npc)`，周期性检查NPC是否满足某个新故事节点的`trigger_conditions`。如果满足，则将其故事推进到新阶段。
- **`NPCManager` (AI集成)**:
  - NPC的`UpdateGoal`函数在做决策时，会检查当前激活的故事节点。
  - 故事节点中定义的需求（如“急需筑基丹”）会极大地提升NPC寻求对应物品的目标分数，使其主动前来玩家店铺求购或发布采购任务。
- **玩家交互**: 当玩家与处于激活故事节点的NPC交互时，`DialogueManager`会加载该节点的`player_interaction_options`，为玩家提供特殊的、能改变故事走向的对话选项。

### 4.3 系统特色
- **制作驱动**: 玩家的制作和交易行为是推动故事发展的核心。你能否提供NPC所需的高品质物品，将直接决定他们的命运。
- **多重分支**: 每个关键节点都有多个分支，导向不同的结局，提升了重玩价值。
- **动态生成**: 系统可以根据NPC的`needs`和当前世界事件，动态生成一些小的、非主线的程序化故事节点（如“最近妖兽暴动，我需要一些防御符箓保命”）。

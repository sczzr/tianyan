# 制作与经济系统技术实现

本篇文档整合了游戏中所有与“生产”和“商业”相关的核心玩法，包括常规制作、高级经济活动以及这些活动背后的管理器实现。

---

## 1. 制作系统 (`CraftingManager.cs`)

负责将原材料转化为成品的逻辑。

### 1.1 常规制作
- **核心逻辑 (`ExecuteCraft`)**:
  1.  玩家在对应的**制作台**选择**蓝图**。
  2.  `CraftingManager`调用`InventoryManager.TryRemoveItems()`扣除材料。
  3.  **品质计算**: 结果由**生产天赋**、**熟练度**、**材料品质**和**制作台等级**等多种因素综合决定。
  4.  产物添加入背包，并为玩家增加对应的“生产天赋”熟练度。
- **UI**: `CraftingUI.tscn`，在制作台前打开，提供配方选择和制作功能。

### 1.2 制作台 (Crafting Stations)
不同的“修真百艺”需要在不同的制作台前进行，制作台可升级。
- **炼丹炉 (Alchemy Bench)**
- **炼器炉 (Smithy/Forge)**
- **符箓台 (Talisman Table)**
- **阵法台 (Formation Altar)**
- **傀儡台 (Puppet Workbench)**
- **酿酒台 (Brewery)**
- **灶台 (Stove)**
- **织机 (Loom)**
- **铭文台 (Engraving Table)**
- **蛊皿/毒鼎 (Gu Vessel/Poison Cauldron)**
- **书案 (Calligraphy Desk)**: 用于【画道】和【卜算】。

---

## 2. 背包与物品管理 (`InventoryManager.cs`)

为所有物品交互提供基础API。

- **数据结构**: `InventoryData.cs`，区分可堆叠物品(`stackableItems`)和唯一实例物品(`uniqueItems`)。
- **核心逻辑**: 提供`HasItems`, `TryRemoveItems`, `AddItem`等原子操作接口。

---

## 3. 交易与市场系统

### 3.1 基础交易 (`TradingManager.cs`)
负责玩家与NPC间的直接交易。
- **`CalculatePrice`**: 核心定价函数，综合基准价、关系、需求、性格、市场事件等动态计算价格。
- **`ExecuteTransaction`**: 安全地执行双方物品和灵石的交换。
- **讨价还价 (Haggling)**: 交易时可触发的迷你游戏，成功率和效果受关系、性格和“商道”技能影响。

### 3.2 高级经济活动 (`EconomyManager.cs`, `AuctionManager.cs`等)
这些系统为游戏后期提供宏观经济玩法。

- **供应商与采购**: 
  - 玩家可与NPC签订**供货契约**，建立长期稳定的供应链。
  - 通过提升**供应商关系等级**可获得更优价格和稀有材料。
- **拍卖行**:
  - `AuctionManager`定期举办拍卖会。
  - 玩家可寄拍自己的极品道具，也可参与竞拍。
  - 竞拍过程由NPC的**财富、需求、性格**驱动，充满博弈。
- **期货市场**:
  - 在“四海商会”等地点交易标准化的**“未来交割契约”**。
  - 核心玩法是利用**信息差**（如提前得知宗门动向、通过卜算预测丰收或灾年）来投机获利。
- **玩家任务发布**:
  - 玩家可在公会发布**采购、护送**等任务，并设定报酬。
  - `NPCManager`的AI会评估并接取这些任务，任务结果存在成功或失败的风险。

### 3.3 宗门与洞天经济
- **洞天福地 (`GrottoManager.cs`)**: 是玩家中后期高品质、可再生材料的核心来源，是支撑高级制作和交易的基础。其核心是`CatchUp`函数，用于精确计算离线收益。
- **宗门 (`SectManager.cs`)**: 作为一个超级“客户”和“供应商”，宗门通过发布**大宗订单**和举办**大型活动**（大比、秘境探索），阶段性地剧烈影响市场供需，为玩家创造商机和挑战。
